<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jjimenezshaw/Leaflet.Control.Layers.Tree@master/L.Control.Layers.Tree.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
    <style>
        body, html, #map { height: 100%; margin: 0; padding: 0; }
        .popup { text-align: left; }

        .custom-legend {
            background-color: rgba(255,255,255, 0.9);
            outline-width: 0px;
            border: 1px solid rgba(0,0,0,0.2) !important;
            outline: none !important;
            box-shadow: 5px 5px 7px rgb(163, 160, 160, 0.4) !important;
        }

        .leaflet-control.abstract {
            text-align: justify;
            font-size: 12px;
            line-height: 20px;
            font-family: 'Open Sans', Helvetica, sans-serif;
            padding: 12px 16px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 6px;
            max-width: 350px;
            box-shadow: 0 0 12px rgba(0,0,0,0.2);
        }

        .leaflet-control.filter-panel {
            font-size: 12px;
            font-family: 'Open Sans', Helvetica, sans-serif;
            padding: 12px 16px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 6px;
            max-width: 250px;
            box-shadow: 0 0 12px rgba(0,0,0,0.2);
            border: 1px solid rgba(0,0,0,0.2);
        }

        .filter-toggle {
            cursor: pointer;
            margin: 0;
            user-select: none;
            font-weight: bold;
        }

        .filter-arrow {
            display: inline-block;
            margin-left: 5px;
            transition: transform 0.2s ease;
        }

        .filter-content {
            margin-top: 10px;
            overflow: hidden;
            max-height: 300px;
            transition: max-height 0.3s ease;
        }

        .filter-content.collapsed {
            max-height: 0;
        }

        .filter-group {
            margin-bottom: 12px;
        }

        .filter-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .filter-group select {
            width: 100%;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 11px;
        }

        .filter-group input[type="checkbox"] {
            margin-right: 6px;
        }

        .clear-filters {
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 10px;
            width: 100%;
            margin-top: 8px;
        }

        .clear-filters:hover {
            background: #e0e0e0;
        }

        #abstract-toggle {
            cursor: pointer;
            margin: 0;
            user-select: none;
        }

        #abstract-arrow {
            display: inline-block;
            margin-left: 5px;
            transition: transform 0.2s ease;
        }

        #abstract-content img {
            display: block;
            width: 76%;
            margin: auto;
        }
        #abstract-content {
            overflow: hidden;
            max-height: 500px; 
            transition: max-height 0.3s ease;
        }
        #abstract-content.collapsed {
            max-height: 0; 
        }
        .Label_Parks {
            background: none !important;      
            border: none !important;          
            box-shadow: none !important;      
            padding: 0 !important;            
            font-family: 'Verdana', sans-serif;
            font-size: 10pt;
            font-style: italic;
            color: #294d29;
            text-shadow: -1px -1px 0 #ffffff,
                        -1px 1px 0 #ffffff,
                        1px 1px 0 #ffffff,
                        1px -1px 0 #ffffff;
        }

        .Label_Parks.leaflet-tooltip::before {
            content: none !important;
        }

        .leaflet-interactive:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        .legend-disabled {
            opacity: 0.4; 
            pointer-events: none;
        }

        .legend-container {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.2);
            box-shadow: 0 0 12px rgba(0,0,0,0.2);
            font-family: 'Open Sans', Helvetica, sans-serif;
            font-size: 12px;
            max-width: 90vw;
            padding-bottom: 10px;
        }

        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            border-bottom: 1px solid #ddd;
            gap: 8px;
        }

        .legend-toggle {
            transition: transform 0.2s ease;
        }

        .legend-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .legend-body {
            background-color: rgba(255, 255, 255, 0.5);
            padding: 5px 10px 5px 10px;
            overflow: visible;
            max-height: none;
        }

        .legend-body.collapsed {
            display: none;
        }

        @media (max-width: 768px){

            .leaflet-control {
                font-size: 11px;
                max-width: 90vw;
            }

            .custom-legend {
                max-height: 60vh;
                overflow-y: auto;
            }

            .leaflet-control.filter-panel,
            .leaflet-control.abstract{
                max-width: 90vw;
                padding: 8px 10px;
            }

            .lealet-popup-content{
                max-width: 90vW !important;
            }

            .popup table {
                width: 100%;
            }

            .popup td {
                display: block;
                width: 100%;
            }

            .leaflet-control-attribution {
                max-width: 60vw;
                white-space: normal;
                text-align: right;
                line-height: 1.2;
            }

        }

    </style>
    <title>West Kootenay Cycling Routes Map</title>
    <link rel="icon" type="image/x-icon" href="images/WKCC.png">
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/jjimenezshaw/Leaflet.Control.Layers.Tree@master/L.Control.Layers.Tree.js"></script>
    <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>
    <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
    <script>
    //**This first section of the script puts in place the basic elements to build our map from**
    var map = L.map('map', {
        zoomControl:false, 
        maxZoom:16, 
        minZoom:8,
        doubleClickZoom: false
    }).setView([49.8, -117.9], 9);

    L.control.scale({
        position: 'bottomright', 
        metric: true,           
        imperial: false,        
        maxWidth: 200           
    }).addTo(map);

    L.control.locate({
        position: 'bottomright',
        flyTo: true,
        showCompass: true,
        strings: {
            title: "Show my location"
        }
    }).addTo(map);

    // Creating custom panes for better layer organization
    map.createPane('terrainPane');
    map.getPane('terrainPane').style.zIndex = 250;
    
    map.createPane('boundariesPane'); 
    map.getPane('boundariesPane').style.zIndex = 350;
    
    map.createPane('routesPane');
    map.getPane('routesPane').style.zIndex = 450;
    
    map.createPane('BikePackingPane');
    map.getPane('BikePackingPane').style.zIndex = 470;
    
    map.createPane('pointsPane');
    map.getPane('pointsPane').style.zIndex = 550;

    //**This section deals with establishing, loading and styling layers. Follow New_Layer comments as a guide to insert a new layer into the project**
    // Declare layer variables for future use
    var Existing_Routes = L.layerGroup(); 
    var Proposed_Routes = L.layerGroup(); 
    var Municipal_Parks = L.layerGroup(); 
    var Provincial_Parks= L.layerGroup();
    var Municipal_Boundaries= L.layerGroup();
    var Regional_Districts_Boundaries= L.layerGroup();
    var Bike_Shops = L.layerGroup(); 
    var Recreation_Sites = L.layerGroup();
    var BC_Transit_Stops = L.layerGroup();
    var Frog_Peak_Loop= L.layerGroup();
    var Kootenay_Confluence= L.layerGroup(); 
    var Santa_Rosa_Valleys_and_Vistas = L.layerGroup();
    var Bonnington_Scrambler= L.layerGroup();
    var Log_Jam_Loop = L.layerGroup();
    var Priority_Improvements = L.layerGroup();

    //Highlight globals
    var existingRoutesFeatures=[];
    var highlightedRoute=null;


    //Linking to tile layers used as our basemaps
    var cartoDB = L.tileLayer("https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png", {
        attribution: '<a href="https://cartodb.com/basemaps/">Map tiles by CartoDB, under CC BY 3.0. Data by OpenStreetMap, under ODbL.</a>',
    }).addTo(map);

    var esri = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    });

    var hillshadeLayer = L.tileLayer("hillshade_tiles/{z}/{x}/{y}.png", {
        pane: 'terrainPane',
        maxZoom: 14,
        minZoom: 8,
        opacity: 0.7,
    }).addTo(map);

    var contoursLayer = L.vectorGrid.protobuf('https://api.maptiler.com/tiles/contours-v2/{z}/{x}/{y}.pbf?key=MjRuIt3YXiPwNbQiRoht', {
        pane: 'terrainPane',
        vectorTileLayerStyles: {"contour": {color: "#c4d4f2", weight: 0.5}, "contour_ft": {opacity: 0}, "high-res": {opacity: 0}},
        maxZoom: 14,
        minZoom: 8,
        attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>'
    });

    //**This next secion establishes the functions that are used within the web map, such as filters and the legend**
    // Global variables for filtering

    var routeFilters = {
        type: 'all',
        surface: 'all',
        transCanadaTrail: false
    };

    function Label_Parks(feature, layer) {
    if (!feature.properties['park_name']) return;

    if (window.innerWidth < 768) {
        // Mobile: tap to toggle tooltip
        layer.on('click', function () {
        layer.bindPopup(feature.properties['park_name']).openPopup();
            });
    } else {
        // Desktop: hover tooltip
        layer.bindTooltip(feature.properties['park_name'], {
        className: 'Label_Parks',
        sticky: true
            });
        }
    }

    // Function to get route style based on filter state
    function getRouteStyle(feature, isDimmed) {
        if (isDimmed) {
            return {
                color: "rgba(17,116,6,0.3)", 
                weight: 3, 
                opacity: 0.4
            };
        } else {
            return {
                color: "rgba(17,116,6,1.0)", 
                weight: 3, 
                opacity: 0.9
            };
        }
    }

    function highlightRoute(layer) {
        resetHighlightedRoute();

        highlightedRoute = layer;
        highlightedRouteOriginalStyle = layer.options.style || null;

        layer.setStyle({
            color: "#f0fc03",
            weight: 5,
            opacity: 1,
        });

        layer.bringToFront();
    }

    function getExistingRouteBaseStyle(feature, dimmed) {
        return getRouteStyle(feature, dimmed);
    }

    function getProjectedRouteBaseStyle() {
        return {
            color: 'rgba(252,0,0,1.0)',
            dashArray: '4,2',
            weight: 1,
            opacity: 1
        };
    }

    function resetHighlightedRoute() {
        if (!highlightedRoute) return;

        if (highlightedRoute.routeCategory === "existing") {
            var matches = featureMatchesFilters(highlightedRoute.feature);
            highlightedRoute.setStyle(
                getExistingRouteBaseStyle(highlightedRoute.feature, !matches)
            );
        }

        if (highlightedRoute.routeCategory === "proposed") {
            highlightedRoute.setStyle(
                getProjectedRouteBaseStyle()
            );
        }

        highlightedRoute = null;
    }
        // Function to check if a feature matches current filters
    function featureMatchesFilters(feature) {
        var props = feature.properties;
        
        // Check type filter
        if (routeFilters.type !== 'all' && props.Type !== routeFilters.type) {
            return false;
        }
        
        // Check surface filter
        if (routeFilters.surface !== 'all' && props.Surface !== routeFilters.surface) {
            return false;
        }
        
        // Check Trans Canada Trail filter
        if (routeFilters.transCanadaTrail && props.Trans_Canada_Trail !== true) {
            return false;
        }
        
        return true;
    }

    // Function to update route styling based on filters
    function updateRouteFiltering() {
        existingRoutesFeatures.forEach(function(layer) {
            var matches = featureMatchesFilters(layer.feature);
            if (highlightedRoute === layer && !matches){
                resetHighlightedRoute();
            }
            if (layer !== highlightedRoute){
                layer.setStyle(getRouteStyle(layer.feature, !matches));
            }
        });
    }

    var popup = L.popup();
    function onMapClick(e) {
        popup
            .setLatLng(e.latlng)
            .setContent(
                "<b>You selected the following location</b><br>"+
                "<b>Lat: </b>" + e.latlng.lat.toFixed(6) + "<br>" +
                "<b>Long: </b>" + e.latlng.lng.toFixed(6)
            )
            .openOn(map)
    }
    map.on("dblclick", onMapClick);

    // Load Existing Routes with filtering capability
    $.getJSON("data/Existing_Routes.geojson", function(data) {
        L.geoJSON(data, {
            pane: 'routesPane',
            attribution: "¬© 2025 West Kootenay Cycling Coalition and Contributors",
            style: function(feature) {
                return getRouteStyle(feature, false);
            },
            interactive: true,
            onEachFeature: function(feature, layer) {

                // Store reference to layer for filtering
                layer.routeCategory="existing";
                existingRoutesFeatures.push(layer);

                layer.on("click", function (e) {
                    highlightRoute(layer);
                    L.DomEvent.stopPropagation(e);
                });
                
                // Safely get properties with fallbacks
                var props = feature.properties || {};
                var name = props.Name || props.name || 'Unnamed Route';
                var type = props.Type || props.type || 'Unknown';
                var tenure = props.Tenure || props.tenure || 'Unknown';
                var source = props.Source || props.source || '';
                var length = props.Shape_length || props.length || props.Length || 'Unknown';
                var description = props.description || props.Description || 'No description available';
                var surface = props.Surface || props.surface || 'Unknown';
                var tct = props.Trans_Canada_Trail || props.trans_canada_trail || 'No';
                
                var displayUrl = source.length > 40 ? source.substring(0, 40) + "[...]" : source;
                var sourceLink = source ? '<a href="' + source + '" target="_blank">' + displayUrl + '</a>' : 'No source';
                
                layer.bindPopup(
                    '<div class="popup">' +
                    '<table>' +
                        '<tr><td><b>Name:</b></td><td>' + name + '</td></tr>' +
                        '<tr><td><b>Type:</b></td><td>' + type + '</td></tr>' +
                        '<tr><td><b>Network:</b></td><td>' + tenure + '</td></tr>' +
                        '<tr><td><b>Source:</b></td><td>' + sourceLink + '</td></tr>' +
                        '<tr><td><b>Length (km):</b></td><td>' + length + '</td></tr>' +
                        '<tr><td><b>Description:</b></td><td><p style="margin:0; max-width:200px; white-space:normal;">' + description + '</p></td></tr>' +
                        '<tr><td><b>Surface:</b></td><td>' + surface + '</td></tr>' +
                        '<tr><td><b>Trans Canada Trail:</b></td><td>' + tct + '</td></tr>' +
                    '</table>' +
                    '</div>'
                );
            }
        }).addTo(Existing_Routes);
        
        // Populate filter dropdowns after data is loaded
        populateFilterDropdowns(data);
    });

    // Function to populate filter dropdowns with unique values
    function populateFilterDropdowns(geojsonData) {
        var types = new Set();
        var surfaces = new Set();
        
        geojsonData.features.forEach(function(feature) {
            if (feature.properties.Type) types.add(feature.properties.Type);
            if (feature.properties.Surface) surfaces.add(feature.properties.Surface);
        });
        
        // Populate type dropdown
        var typeSelect = document.getElementById('type-filter');
        Array.from(types).sort().forEach(function(type) {
            var option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            typeSelect.appendChild(option);
        });
        
        // Populate surface dropdown  
        var surfaceSelect = document.getElementById('surface-filter');
        Array.from(surfaces).sort().forEach(function(surface) {
            var option = document.createElement('option');
            option.value = surface;
            option.textContent = surface;
            surfaceSelect.appendChild(option);
        });
    }
    
    // Load and style Proposed Routes
    $.getJSON("data/Proposed_Routes.geojson", function(data) {
        L.geoJSON(data, {
            pane: 'routesPane',
            attribution: "¬© 2025 West Kootenay Cycling Coalition and Contributors",
            style: {
                opacity: 1,
                color: 'rgba(252,0,0,1.0)',
                dashArray: '4.0,2.0',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0 
            },
            interactive: true,
            onEachFeature: function(feature, layer) {
                layer.routeCategory="proposed";

                layer.on("click", function (e){
                    highlightRoute(layer);
                    L.DomEvent.stopPropagation(e);
                });
            }
        }).addTo(Proposed_Routes);
    });

    // Load and style Municipal Parks
    $.getJSON("data/Municipal_Parks.geojson", function(data) {
        L.geoJSON(data, {
            attribution: '¬©<a href="https://www2.gov.bc.ca/gov/content/data/policy-standards/data-policies/open-data/open-government-licence-bc">Open Government Licence - British Columbia</a>',
            style: {
                opacity: 1,
                color: 'rgba(37,96,18,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(114,155,111,0.6039215686274509)'
            },
            interactive: true,
            onEachFeature: Label_Parks
        }).addTo(Municipal_Parks);
    });

    // Load and style Provincial Parks
    $.getJSON("data/Provincial_Parks.geojson", function(data) {
        L.geoJSON(data, {
            attribution: '¬©<a href="https://www2.gov.bc.ca/gov/content/data/policy-standards/data-policies/open-data/open-government-licence-bc">Open Government Licence - British Columbia</a>',
            style: {   
                opacity: 1,
                color: 'rgba(37,96,18,1.0)',
                dashArray: '5.0,1.0',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 0.6,
                fillColor: 'rgba(114,155,111,0.6039215686274509)'
            },
            interactive: true,
            onEachFeature: Label_Parks
        }).addTo(Provincial_Parks);
    });

    // Load and style Municipal Boundaries
    $.getJSON("data/Municipal_Boundaries.geojson", function(data) {
        L.geoJSON(data, {
            pane: 'boundariesPane',
            attribution: '¬©<a href="https://www2.gov.bc.ca/gov/content/data/policy-standards/data-policies/open-data/open-government-licence-bc">Open Government Licence - British Columbia</a>',
            style: {   
                opacity: 0.15,
                color: 'rgba(255,142,37)',
                dashArray: '10.0,2.0,4.0,2.0',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(255,158,23,0.0)'
            },
            minZoom: 11,
            maxZoom: 16,
            interactive: false
        }).addTo(Municipal_Boundaries);
    });
    
    // Load and style Regional Districts Boundaries
    $.getJSON("data/Regional_Districts_Boundaries.geojson", function(data) {
        L.geoJSON(data, {
            attribution: '¬©<a href="https://www2.gov.bc.ca/gov/content/data/policy-standards/data-policies/open-data/open-government-licence-bc">Open Government Licence - British Columbia</a>',
            pane: 'boundariesPane',
            style: { 
                opacity: 0.3,
                color: 'rgba(128,128,128,1.0)',
                dashArray: '15.0,3.0,6.0,3.0',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 3.0, 
                fillOpacity: 0
            },
            interactive: false
        }).addTo(Regional_Districts_Boundaries);   
    });

    // Load and style Bike Shops
    $.getJSON("data/Bike_Shops.geojson", function(data) {
        L.geoJSON(data, {
            pane: 'pointsPane',
            pointToLayer: function(feature, latlng) {
                return L.marker(latlng, {
                    icon: L.icon({
                        iconUrl: 'markers/BikeShops_12.svg',
                        iconSize: [19, 19],
                        iconAnchor: [9, 9] 
                    })
                });
            },
            //Allowing and formatting popups
            interactive: true,
            onEachFeature: function(feature, layer) {
                var url = feature.properties.URL || "";
                var displayUrl = url.length > 40 ? url.substring(0, 40) + "[...]" : url;
                layer.bindPopup(
                    '<div class="popup">' +
                    '<table>' +
                        '<tr><td><b>Name:</b></td><td>' + feature.properties.Name + '</td></tr>' +
                        '<tr><td><b>Address:</b></td><td>' + feature.properties.StreetAddress + '</td></tr>' +
                        '<tr><td><b>City:</b></td><td>' + feature.properties.City + '</td></tr>' +
                        '<tr><td><b>Province:</b></td><td>' + feature.properties.Province + '</td></tr>' +
                        '<tr><td><b>Postal Code:</b></td><td>' + feature.properties.PostalCode + '</td></tr>' +
                        '<tr><td><b>URL:</b></td><td><a href="' + url + '" target="_blank">' + displayUrl + '</a></td></tr>' +
                        '<tr><td><b>Phone Number:</b></td><td>' + feature.properties.PhoneNumber + '</td></tr>' +
                    '</table>' +
                    '</div>'
                );
            }            
        }).addTo(Bike_Shops);
    });

    // Load and style Recreation Sites
    $.getJSON("data/Recreation_Sites.geojson", function(data) {
        L.geoJSON(data, {
            attribution: '¬©<a href="https://www2.gov.bc.ca/gov/content/data/policy-standards/data-policies/open-data/open-government-licence-bc">Open Government Licence - British Columbia</a>',
            pane: 'pointsPane',
            pointToLayer: function(feature, latlng) {
                var RecSite = L.icon({
                    iconUrl: 'markers/picnic-2.png',
                    iconSize: [20, 20],
                    iconAnchor: [5, 5] 
                });
                return L.marker(latlng, { icon: RecSite });
            },
            //Allowing and formating popups
            interactive: true,
            onEachFeature: function(feature, layer) {
                layer.bindPopup(
                    '<div class="popup" style="width:600px;">' +
                    '<table style="width:100%;">' +
                        '<tr><td style="padding-right:15px;"><b>Name:</b></td><td>' + feature.properties.project_name + '</td></tr>' +
                        '<tr><td style="padding-right:15px;"><b>Number of<br> Camp Sites:</b></td><td>' + feature.properties.num_camp_sites + '</td></tr>' +
                        '<tr><td style="padding-right:15px;"><b>Description:</b></td><td><p style="margin:0; max-width 600px; white-space:normal;">' + feature.properties.project_description + '</p></td></tr>' +
                    '</table>' +
                    '</div>',
                    {maxWidth: 800}
                );
            }
        }).addTo(Recreation_Sites);
    });

    //Load and Style Priority Improvement layer
    $.getJSON("data/Priority_Improvements.geojson", function(data) {
        L.geoJSON(data, {
            attribution: "¬© 2025 West Kootenay Cycling Coalition and Contributors",
            pane: 'pointsPane',
            pointToLayer: function(feature, latlng) {
                var Warning = L.icon({
                    iconUrl: 'markers/Warning.svg',
                    iconSize: [20, 20],
                    iconAnchor: [5, 5] 
                });
                return L.marker(latlng, { icon: Warning });
            },
            //Allowing and formating popups
            interactive: true,
            onEachFeature: function(feature, layer) {
                layer.bindPopup(
                    '<div class="popup" style="width:600px;">' +
                    '<table style="width:100%;">' +
                        '<tr><td style="padding-right:15px;"><b>Name:</b></td><td>' + feature.properties.Name + '</td></tr>' +
                        '<tr><td style="padding-right:15px;"><b>Description:</b></td><td>' + feature.properties.Description + '</td></tr>' +
                        '<tr><td style="padding-right:15px;"><b>Comments:</b></td><td>' + feature.properties.Comments + '</td></tr>' +
                        '<tr><td style="padding-right:15px;"><b>URL:</b></td><td>' + feature.properties.URL + '</td></tr>' +
                        '<tr><td style="padding-right:15px;"><b>Priority:</b></td><td><p style="margin:0; max-width 600px; white-space:normal;">' + feature.properties.Priority + '</p></td></tr>' +
                    '</table>' +
                    '</div>',
                    {maxWidth: 800}
                );
            }
        }).addTo(Priority_Improvements);
    });

    // Load and style BC Transit Stops
    $.getJSON("data/BC_Transit_Stops.geojson", function(data) {
        L.geoJSON(data, {
            attribution: '¬©<a href="https://www.bctransit.com/open-data/terms-of-use/">BC Transit Terms of Use</a>',
            pane: 'pointsPane',
            pointToLayer: function(feature, latlng) {
                return L.marker(latlng, {
                    icon: L.icon({
                        iconUrl: 'markers/BCTransitStops_10.svg',
                        iconSize: [14, 14],
                        iconAnchor: [7, 7]
                    })
                });
            },
        }).addTo(BC_Transit_Stops);
    });

    // Load and style Named Routes
    $.getJSON("data/Frog_Peak_Loop.geojson", function(data) {
        L.geoJSON(data, {
            pane: 'BikePackingPane',
            attribution: '¬©<a href="https://bikepacking.com/west-kootenay/">Moe Nadeau - BikePacking.com</a>',
            style: {
                opacity: 1,
                color: 'rgba(247,72,33,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 2.0,
                fillOpacity: 0
            },
            //Allowing and formatting popups
            interactive: true,
            onEachFeature: function(feature, layer) {
                var url = feature.properties.Source || "";
                var displayUrl = url.length > 40 ? url.substring(0, 40) + "[...]" : url;
                layer.bindPopup(
                    '<div class="popup">' +
                    '<table>' +
                        '<tr><td><b>Name:</b></td><td>' + feature.properties.name + '</td></tr>' +
                        '<tr><td><b>Length (km):</b></td><td>' + feature.properties.Length + '</td></tr>' +
                        '<tr><td><b>Source:</b></td><td><a href="' + url + '" target="_blank">' + displayUrl + '</a></td></tr>' +
                    '</table>' +
                    '</div>'
                );
            }
        }).addTo(Frog_Peak_Loop);
    });
    //Load and style Kootenay Confluence
    $.getJSON("data/Kootenay_Confluence.geojson", function(data) {
        L.geoJSON(data, {
            pane: 'BikePackingPane',
            attribution: '¬©<a href="https://bikepacking.com/west-kootenay/">Moe Nadeau - BikePacking.com</a>',
            style: {
                opacity: 1,
                color: 'rgba(247,222,33,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 2.0,
                fillOpacity: 0
            },
            //Allowing and formatting popups
            interactive: true,
            onEachFeature: function(feature, layer) {
                var url = feature.properties.Source || "";
                var displayUrl = url.length > 40 ? url.substring(0, 40) + "[...]" : url;
                layer.bindPopup(
                    '<div class="popup">' +
                    '<table>' +
                        '<tr><td><b>Name:</b></td><td>' + feature.properties.name + '</td></tr>' +
                        '<tr><td><b>Length (km):</b></td><td>' + feature.properties.Length + '</td></tr>' +
                        '<tr><td><b>Source:</b></td><td><a href="' + url + '" target="_blank">' + displayUrl + '</a></td></tr>' +
                    '</table>' +
                    '</div>'
                );
            }
        }).addTo(Kootenay_Confluence);
    });
    //Load and style Santa Rosa Valleys and Vistas 
    $.getJSON("data/Santa_Rosa_Valleys_and_Vistas.geojson", function(data) {
        L.geoJSON(data, {
            pane: 'BikePackingPane',
            attribution: '¬©<a href="https://bikepacking.com/west-kootenay/">Moe Nadeau - BikePacking.com</a>',
            style: {
                opacity: 1,
                color: 'rgba(132,55,38,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 2.0,
                fillOpacity: 0
            },
            //Allowing and formatting popups
            interactive: true,
            onEachFeature: function(feature, layer) {
                var url = feature.properties.Source || "";
                var displayUrl = url.length > 40 ? url.substring(0, 40) + "[...]" : url;
                layer.bindPopup(
                    '<div class="popup">' +
                    '<table>' +
                        '<tr><td><b>Name:</b></td><td>' + feature.properties.name + '</td></tr>' +
                        '<tr><td><b>Length (km):</b></td><td>' + feature.properties.Length + '</td></tr>' +
                        '<tr><td><b>Source:</b></td><td><a href="' + url + '" target="_blank">' + displayUrl + '</a></td></tr>' +
                    '</table>' +
                    '</div>'
                );
            }
        }).addTo(Santa_Rosa_Valleys_and_Vistas);
    });
    //Load and style Bonnington Scrambler
    $.getJSON("data/Bonnington_Scrambler.geojson", function(data) {
        L.geoJSON(data, {
            attribution: '¬©<a href="https://bikepacking.com/west-kootenay/">Moe Nadeau - BikePacking.com</a>',
            pane: 'BikePackingPane',
            style: {
                opacity: 1,
                color: 'rgba(255,170,23,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 2.0,
                fillOpacity: 0
            },
            //Allowing and formatting popups
            interactive: true,
            onEachFeature: function(feature, layer) {
                var url = feature.properties.Source || "";
                var displayUrl = url.length > 40 ? url.substring(0, 40) + "[...]" : url;
                layer.bindPopup(
                    '<div class="popup">' +
                    '<table>' +
                        '<tr><td><b>Name:</b></td><td>' + feature.properties.name + '</td></tr>' +
                        '<tr><td><b>Length (km):</b></td><td>' + feature.properties.Length + '</td></tr>' +
                        '<tr><td><b>Source:</b></td><td><a href="' + url + '" target="_blank">' + displayUrl + '</a></td></tr>' +
                    '</table>' +
                    '</div>'
                );
            }
        }).addTo(Bonnington_Scrambler);
    });
    //Load and style Log Jam Loop
    $.getJSON("data/Log_Jam_Loop.geojson", function(data) {
    L.geoJSON(data, {
        attribution: '¬©<a href="https://bikepacking.com/west-kootenay/">Moe Nadeau - BikePacking.com</a>',
        pane: 'BikePackingPane',
        style: {
            opacity: 1,
            color: 'rgba(54,81,231,1.0)',
            dashArray: '',
            lineCap: 'square',
            lineJoin: 'bevel',
            weight: 2.0,
            fillOpacity: 0
        },
        //Allowing and formatting popups
        interactive: true,
        onEachFeature: function(feature, layer) {
            var url = feature.properties.Source || "";
            var displayUrl = url.length > 40 ? url.substring(0, 40) + "[...]" : url;
            layer.bindPopup(
                '<div class="popup">' +
                '<table>' +
                    '<tr><td><b>Name:</b></td><td>' + feature.properties.name + '</td></tr>' +
                    '<tr><td><b>Length (km):</b></td><td>' + feature.properties.Length + '</td></tr>' +
                    '<tr><td><b>Source:</b></td><td><a href="' + url + '" target="_blank">' + displayUrl + '</a></td></tr>' +
                '</table>' +
                '</div>'
            );
        }
    }).addTo(Log_Jam_Loop);
    });
    //Example code to load a newly created layer into the web map
    // $.getJSON("data/New_Layer.geojson", function(data) {
    //    L.geoJSON(data, {
    //      pane: 'routesPane', // Options: terrainPane, boundariesPane, routesPane, BikePackingPane, pointsPane
                 
        //  POLYGON/LINE STYLING EXAMPLE:
        //  style: {
        //      opacity: 1,
        //      color: 'rgba(255,0,0,1.0)',      // Border color
        //      dashArray: '5.0,2.0',            // Dashed line pattern (optional)
        //      lineCap: 'round',                // Line endings: 'round', 'square', 'butt'
        //      lineJoin: 'round',               // Line joints: 'round', 'bevel', 'miter'
        //      weight: 2.0,                     // Border thickness
        //      fill: true,                      // Fill polygons (set false for lines)
        //      fillOpacity: 0.6,                // Polygon fill transparency
        //      fillColor: 'rgba(255,0,0,0.3)'   // Polygon fill color
        //    },
                 
        // // POINT STYLING EXAMPLE (comment out 'style' above and use this instead):
        //    pointToLayer: function(feature, latlng) {
        //      return L.marker(latlng, {
        //          icon: L.icon({
        //          iconUrl: 'markers/your_icon.svg',  // Path to your marker icon
        //          iconSize: [20, 20],               // Icon dimensions [width, height]
        //          iconAnchor: [10, 10]              // Icon anchor point [x, y]
        //                  })
        //          });
        //       },
        //         
        //    interactive: false, // Set false if you don't want clicks/hovers or popups
        //         
        //    POPUP CONFIGURATION:
        //    onEachFeature: function(feature, layer) {
        //  
        //    var props = feature.properties || {};
        //    var name = props.Name || props.name || 'Unknown';
        //    var description = props.Description || props.description || 'No description';
        //             
        //    *Create popup content*
        //      layer.bindPopup(
        //          '<div class="popup">' +
        //              '<table>' +
        //                  '<tr><td><b>Name:</b></td><td>' + name + '</td></tr>' +
        //                  '<tr><td><b>Description:</b></td><td>' + description + '</td></tr>' +
        //                 *Add more properties as needed*
        //                 '</table>' +
        //                 '</div>'
        //             );
        //         }
        //     }).addTo(New_Layer);
        // });

//Adding Layers to the map
var defaultLayers = [
    Existing_Routes,
    Proposed_Routes,
    Municipal_Parks,
    Provincial_Parks,
    Municipal_Boundaries,
    Regional_Districts_Boundaries,
    Priority_Improvements
];

defaultLayers.forEach(l => l.addTo(map));

    //**This section is where the legend gets built**
   
    function createLegendIcon(iconFile, label) {
    return '<img src="legend/' + iconFile + '" style="height:16px;vertical-align:middle;margin-right:4px;">' + label;
    };

    const LegendContainer = L.Control.extend({
        options: {
            position: 'topright'
        },
        onAdd: function () {
            const container = L.DomUtil.create(
                'div',
                'leaflet-control legend-container'
            );
            L.DomEvent.disableClickPropagation(container);
            L.DomEvent.disableScrollPropagation(container);

            container.innerHTML = `
                <div class="legend-header">
                    <span>Legend</span>
                    <span class="legend-toggle">‚ñæ</span>
                </div>
                <div class="legend-body"></div>
                `;
            return container;
        }
    });

    const legendContainer = new LegendContainer();
    legendContainer.addTo(map);

    var treeControl = L.control.layers.tree(
            {
                label: '<b>Base Maps</b>',
                children: [
                    {label: 'CartoDB', layer: cartoDB},
                    {label: 'Imagery', layer: esri}
                ]
            },
            {
                label: '<b>Overlays</b>',
                selectAllCheckbox: true,
                children: [
                    {
                        label: '<b>Terrain Overlays</b>',
                        selectAllCheckbox: false,
                        children: [
                            {label: createLegendIcon("hillshade.png", "Hillshade"), layer: hillshadeLayer},
                            {label: createLegendIcon("contours.png", "Contours"), layer: contoursLayer}
                        ]
                    },
                    {
                        label: '<b>Bike Routes</b>',
                        selectAllCheckbox: false,
                        children: [
                            {label: createLegendIcon("existing_routes.png", "Existing Routes"), layer: Existing_Routes},
                            {label: '<span class="legend-proposed-routes">'+createLegendIcon("proposed_routes.png", "Proposed Routes")+'</span>', layer: Proposed_Routes},
                            {label: createLegendIcon("Warning.svg", "Priority Improvements"), layer: Priority_Improvements},
                            {
                                label: '<b>Bike Packing Routes</b>',
                                selectAllCheckbox: false,
                                children: [
                                    {label: createLegendIcon("frog_peak.png", "Frog Peak Loop"), layer: Frog_Peak_Loop},
                                    {label: createLegendIcon("kootenay_confluence.png", "Kootenay Confluence"), layer: Kootenay_Confluence},
                                    {label: createLegendIcon("santa_rosa.png", "Santa Rosa Valleys and Vistas"), layer: Santa_Rosa_Valleys_and_Vistas},
                                    {label: createLegendIcon("bonnington_scrambler.png", "Bonnington Scrambler"), layer: Bonnington_Scrambler},
                                    {label: createLegendIcon("log_jam_loop.png", "Log Jam Loop"), layer: Log_Jam_Loop}
                                ]
                            }
                        ]
                    },
                    {
                        label: '<b>Parks</b>',
                        selectAllCheckbox: false,
                        children: [
                            {label: '<span class="legend-municipal-parks">'+createLegendIcon("municipal_parks.png", "Municipal Parks")+'</span>', layer: Municipal_Parks},
                            {label: createLegendIcon("provincial_parks.png", "Provincial Parks"), layer: Provincial_Parks}
                        ]
                    },
                    {
                        label: '<b>Boundaries</b>',
                        selectAllCheckbox: false,
                        children: [
                            {label:'<span class="legend-municipal-boundaries">'+createLegendIcon("municipal_boundaries.png", "Municipal Boundaries")+'</span>', layer: Municipal_Boundaries},
                            {label: createLegendIcon("regional_districts.png", "Regional Districts"), layer: Regional_Districts_Boundaries}
                        ]
                    },
                    {label: createLegendIcon("bike_shops.png", "Bike Shops"), layer: Bike_Shops},
                    {label: createLegendIcon("picnic-2.png", "Recreation Sites"), layer: Recreation_Sites},
                    {label: createLegendIcon("bc_transit.png", "BC Transit Stops"), layer: BC_Transit_Stops}
                    //**Adding new layer element to the legend
                    //{label: createLegendIcon("New Layer Name"), layer: New_Layer}
                ]
            },
            {
                namedToggle: true,
                selectorBack: false,
                closedSymbol: '&#8862; &#x1f5c0;',
                openedSymbol: '&#8863; &#x1f5c1;',
                spaceSymbol: '&#x00A0;&#x00A0;&#x00A0;',
                collapsed: false,
                position: 'topright'
            }
        ).addTo(map);


        const legendBody = document.querySelector('.legend-body');
        const treeEl = treeControl.getContainer();

        legendBody.appendChild(treeEl);

        const legendHeader = document.querySelector('.legend-header');
        const legendToggle = document.querySelector('.legend-toggle');
        const legendBodyEl = document.querySelector('.legend-body');

        legendHeader.addEventListener('click', () => {
            legendBodyEl.classList.toggle('collapsed');
            legendToggle.classList.toggle('collapsed');
        });

        if (window.innerWidth < 768) {
            legendBodyEl.classList.add('collapsed');
            legendToggle.classList.add('collapsed');
        }

        //*Zoom restriciton for certain layers*
    var zoomRestrictedLayers = [
        { layer: Municipal_Boundaries, legendClass: "legend-municipal-boundaries", minZoom: 12, maxZoom: 16 },
        { layer: Municipal_Parks, legendClass: "legend-municipal-parks", minZoom: 11, maxZoom: 16 },
        { layer: Proposed_Routes, legendClass: "legend-proposed-routes", minZoom: 8, maxZoom: 16 },
        // add more layers here as needed
    ];

    function updateZoomRestrictedLayers() {
        var zoom = map.getZoom();

        zoomRestrictedLayers.forEach(function(item) {
            var legendItem = document.querySelector("." + item.legendClass);
            var labelEl = legendItem ? legendItem.closest("label") : null;
            var checkbox = legendItem ? legendItem.closest("label").querySelector("input[type=checkbox]") : null;

            if (zoom >= item.minZoom && zoom <= item.maxZoom) {
                if (!map.hasLayer(item.layer)) map.addLayer(item.layer);
                if (legendItem) legendItem.classList.remove("legend-disabled");
                if (checkbox) checkbox.disabled = false;
            } else {
                if (map.hasLayer(item.layer)) map.removeLayer(item.layer);
                if (legendItem) legendItem.classList.add("legend-disabled");
                if (checkbox) checkbox.disabled = true;
            }
        });
    }

        // Run once at load
        setTimeout(updateZoomRestrictedLayers, 100);

        // Run on every zoom change
        map.on("zoomend", updateZoomRestrictedLayers);

        var treeContainer = treeControl.getContainer();
        treeContainer.classList.add('custom-legend');

    

        // Create filter panel
        var filterPanel = L.control({ position: 'topleft' });

        filterPanel.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'leaflet-control filter-panel');

            div.innerHTML = `
                <p class="filter-toggle">üîç Route Filters
                    <span class="filter-arrow">‚ñæ</span>
                </p>
                <div class="filter-content collapsed">
                    <div class="filter-group">
                        <label>Route Type:</label>
                        <select id="type-filter">
                            <option value="all">All Types</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Surface:</label>
                        <select id="surface-filter">
                            <option value="all">All Surfaces</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="tct-filter"> Trans Canada Trail Only
                        </label>
                    </div>
                    <button class="clear-filters" onclick="clearAllFilters()">Clear All Filters</button>
                </div>`;

            // Toggle panel
            var toggle = div.querySelector('.filter-toggle');
            var content = div.querySelector('.filter-content');
            var arrow = div.querySelector('.filter-arrow');

            // Set initial state (collapsed)
            arrow.style.transform = 'rotate(180deg)';

            toggle.onclick = function() {
                var isExpanding = content.classList.contains('collapsed');
                
                if(isExpanding) {
                    // Expanding filter panel
                    content.classList.remove('collapsed');
                    arrow.style.transform = 'rotate(0deg)';
                    
                    // Collapse abstract if it's expanded
                    collapseAbstract();
                } else {
                    // Collapsing filter panel
                    content.classList.add('collapsed');
                    arrow.style.transform = 'rotate(180deg)';
                }
            };

            // Prevent map interaction when clicking on controls
            L.DomEvent.disableClickPropagation(div);
            L.DomEvent.disableScrollPropagation(div);

            return div;
        };

        filterPanel.addTo(map);

        // Add event listeners for filters (these will be available once the panel is added)
        setTimeout(function() {
            document.getElementById('type-filter').addEventListener('change', function() {
                routeFilters.type = this.value;
                updateRouteFiltering();
            });

            document.getElementById('surface-filter').addEventListener('change', function() {
                routeFilters.surface = this.value;
                updateRouteFiltering();
            });

            document.getElementById('tct-filter').addEventListener('change', function() {
                routeFilters.transCanadaTrail = this.checked;
                updateRouteFiltering();
            });
        }, 100);

        // Global function to clear all filters
        window.clearAllFilters = function() {
            routeFilters.type = 'all';
            routeFilters.surface = 'all';
            routeFilters.transCanadaTrail = false;
            
            document.getElementById('type-filter').value = 'all';
            document.getElementById('surface-filter').value = 'all';
            document.getElementById('tct-filter').checked = false;
            
            updateRouteFiltering();
        };
        //Creating the abstract section
        var abstract = L.control({ position: 'bottomleft' });

        abstract.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'leaflet-control abstract');

        div.innerHTML = `
            <p id="abstract-toggle"><b>West Kootenay Cycling Map</b>
                <span id="abstract-arrow">‚ñæ</span>
            </p>
            <div id="abstract-content">
                <p>
    This map intends to show the extent of the cycling network in the West Kootenays region, including existing 
    (<img src="legend/existing_routes.png" style="height:16px; width:16px; display:inline-block; vertical-align:middle; margin:0 2px;">) 
    and proposed routes (<img src="legend/proposed_routes.png" style="height:16px; width:16px; display:inline-block; vertical-align:middle; margin:0 2px;">). 
    This project will continue to grow, following the shifts and development within the cycling network. Use the <b>legend</b> and <b>filters</b> to explore the network. Some layers also have <b>popups</b> 
    that can be toggled by clicking their features!
    </p>
    <p>
    We are committed to <b>improving</b> the cycling network and welcome user <b>feedback</b> to guide further updates.
    To report issues or share ideas, <b>please contact us at: </b></br>
    </p>
    <p>
    <a href="https://westkootenaycycling.ca/contact" target="_blank" rel="noopener noreferrer">https://westkootenaycycling.ca/contact</a></br>
    </p>
    <p style="margin-bottom:0;">
    When sending <b>feedback</b>, please include the <b>location</b> (intersection/street name or coordinates).  
    To obtain <b>coordinates</b> on this map, simply <b>double-click</b> a location to display its latitude and longitude.
    </p>
    <img src="images/WKCC.png" alt="WKCC logo" style="width: 200px; height:auto; margin-top:0;">
    </div>`;

        var toggle = div.querySelector('#abstract-toggle');
        var content = div.querySelector('#abstract-content');
        var arrow = div.querySelector('#abstract-arrow');

        // Start expanded
        content.style.display = 'block';

        // Toggle function
        toggle.onclick = function() {
            var isExpanding = content.classList.contains('collapsed');
            
            if(isExpanding) {
                // Expanding abstract
                content.classList.remove('collapsed');
                arrow.style.transform = 'rotate(0deg)';
                
                // Collapse filter if it's expanded
                collapseFilter();
            } else {
                // Collapsing abstract
                content.classList.add('collapsed');
                arrow.style.transform = 'rotate(180deg)';
            }
        };

        return div;
    };
    abstract.addTo(map); 

    // Function that avoids overlapping of the abstract and filter panels
    function collapseAbstract() {
        var abstractContent = document.getElementById('abstract-content');
        var abstractArrow = document.getElementById('abstract-arrow');
        
        if (!abstractContent.classList.contains('collapsed')) {
            abstractContent.classList.add('collapsed');
            abstractArrow.style.transform = 'rotate(180deg)';
        }
    }

    function collapseFilter() {
        var filterContent = document.querySelector('.filter-content');
        var filterArrow = document.querySelector('.filter-arrow');
        
        if (!filterContent.classList.contains('collapsed')) {
            filterContent.classList.add('collapsed');
            filterArrow.style.transform = 'rotate(180deg)';
        }
    }

    if (window.innerWidth < 768) {
        if (treeControl && treeControl.collapse) {
            treeControl.collapse();
        }

        setTimeout(() => {
            if (typeof collapseAbstract === 'function') {
                collapseAbstract();
            }
        }, 200);
    }

    if (window.innerWidth < 768) {
        legendBodyEl.classList.add('collapsed');
        legendToggle.classList.add('collapsed');
    }
        map.on("click", function () {
        resetHighlightedRoute();
    });
    </script>
</body>
</html>
